name: Generate Content Images

on:
  workflow_dispatch:
    inputs:
      use_parallel:
        description: 'Use parallel processing for faster generation'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Generate SVG images (parallel)
        if: inputs.use_parallel == 'true'
        run: pnpm generate:images:parallel

      - name: Generate SVG images (sequential)
        if: inputs.use_parallel == 'false'
        run: pnpm generate:images

      - name: Convert SVG to PNG (parallel)
        if: inputs.use_parallel == 'true'
        run: pnpm convert:svg-to-png:parallel

      - name: Convert SVG to PNG (sequential)
        if: inputs.use_parallel == 'false'
        run: pnpm convert:svg-to-png

      - name: Get timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: generate missing content images'
          branch: chore/generate-images-${{ steps.timestamp.outputs.timestamp }}
          delete-branch: true
          title: 'chore: Generate missing content images'
          body: |
            ## ğŸ¨ Generated Content Images

            This PR contains automatically generated images for content that was missing images or had placeholder images.

            ### ğŸ“Š What's Included

            - **SVG Images**: Vector graphics for all content types
            - **PNG Images**: Optimized 1200x630 social media images (OG tags)

            ### ğŸ“ Content Types

            Images generated for:
            - Posts (blog articles)
            - Guides (learning resources)
            - Exercises (practice challenges)
            - News (weekly digests)
            - Advent of DevOps (seasonal content)

            ### ğŸ” Processing Mode

            - **Parallel Processing**: ${{ inputs.use_parallel }}

            ### â„¹ï¸ Note

            Only images for content without existing images or with placeholder images are generated. Existing images are preserved.

            ---

            ğŸ¤– _This PR was automatically generated by the Generate Images workflow_
          draft: false
          labels: |
            automated
            images
            chore
